<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX LLM ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0d1117;color:#e6edf3;font-family:'Segoe UI',sans-serif;padding:16px}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
.header{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.header h1{font-size:1.25em;color:#58a6ff;flex:1}
.live-dot{width:9px;height:9px;border-radius:50%;background:#3fb950;animation:pulse 2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}
.badge{padding:3px 12px;border-radius:12px;font-size:.78em;font-weight:700;border:1px solid}
.badge-train  {background:#3fb95022;color:#3fb950;border-color:#3fb95066}
.badge-done   {background:#ffa65722;color:#ffa657;border-color:#ffa65766}
.badge-error  {background:#f4433622;color:#f44336;border-color:#f4433666}
.badge-wait   {background:#8b949e22;color:#8b949e;border-color:#8b949e66}

/* â”€â”€ è¨­å®šãƒãƒ¼ â”€â”€ */
.config-bar{display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.config-bar label{font-size:.8em;color:#8b949e}
.config-bar input{background:#161b22;border:1px solid #30363d;color:#e6edf3;
  padding:5px 10px;border-radius:6px;font-size:.82em;width:520px;max-width:100%}
.config-bar select{background:#161b22;border:1px solid #30363d;color:#e6edf3;
  padding:5px 8px;border-radius:6px;font-size:.82em}
.btn{display:inline-block;padding:6px 14px;border-radius:6px;font-size:.82em;font-weight:600;
  cursor:pointer;border:none;text-decoration:none}
.btn-blue{background:#1f6feb;color:#fff}.btn-blue:hover{background:#388bfd}
.btn-green{background:#238636;color:#fff}.btn-green:hover{background:#2ea043}
.btn-gray{background:#21262d;color:#e6edf3;border:1px solid #30363d}.btn-gray:hover{background:#30363d}

/* â”€â”€ ã‚°ãƒªãƒƒãƒ‰ â”€â”€ */
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(max-width:900px){.grid4{grid-template-columns:repeat(2,1fr)}.grid2{grid-template-columns:1fr}}

/* â”€â”€ ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.card{background:#161b22;border:1px solid #30363d;border-radius:8px;padding:14px}
.card h2{font-size:.7em;color:#8b949e;margin-bottom:8px;text-transform:uppercase;letter-spacing:.8px}
.big{font-size:2em;font-weight:700}
.sub{font-size:.75em;color:#8b949e;margin-top:3px}
.bar-wrap{background:#21262d;border-radius:4px;height:10px;overflow:hidden;margin-top:6px}
.bar{height:100%;border-radius:4px;transition:width .5s}
.lrow{display:flex;justify-content:space-between;font-size:.72em;color:#8b949e;margin-top:3px}
.msg{background:#161b22;border-left:3px solid #58a6ff;padding:8px 14px;border-radius:4px;
  font-size:.82em;color:#c9d1d9;margin-bottom:12px;min-height:28px}

/* â”€â”€ ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€ */
table{width:100%;border-collapse:collapse;font-size:.8em}
th,td{padding:6px 10px;text-align:right;border-bottom:1px solid #21262d}
th{color:#8b949e;font-weight:600}td:first-child,th:first-child{text-align:center}
tr:hover td{background:#1c2128}

/* â”€â”€ DL ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â”€â”€ */
.dl-section{margin-top:12px;padding-top:10px;border-top:1px solid #30363d;display:flex;gap:8px;flex-wrap:wrap}
.stat-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:10px}
.stat-item{text-align:center}
.stat-val{font-size:1.4em;font-weight:700}
.stat-lbl{font-size:.7em;color:#8b949e}

/* â”€â”€ ãƒ•ãƒƒã‚¿ãƒ¼ â”€â”€ */
.footer{text-align:right;font-size:.7em;color:#484f58;margin-top:12px}
</style>
</head>
<body>

<div class="header">
  <span class="live-dot" id="dot"></span>
  <h1>FX LLM ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>
  <span class="badge badge-wait" id="phase-badge">å¾…æ©Ÿä¸­</span>
</div>

<div class="config-bar">
  <label>API URL:</label>
  <input type="text" id="api-url"
    value="https://b56aa93b-232b-4cb2-8966-adc5d6b3df63.bcf9c26d-ce43-4d10-8c06-4e8f9390d00e.container.sakurausercontent.com/api/status"
    placeholder="http://<IP>:7860/api/status">
  <label>é–“éš”:</label>
  <select id="interval-sel">
    <option value="3000">3ç§’</option>
    <option value="5000" selected>5ç§’</option>
    <option value="10000">10ç§’</option>
    <option value="30000">30ç§’</option>
  </select>
  <button class="btn btn-blue" onclick="startPolling()">æ¥ç¶š</button>
  <button class="btn btn-gray" onclick="stopPolling()">åœæ­¢</button>
</div>

<div class="msg" id="msg">æ¥ç¶šå¾…æ©Ÿä¸­...</div>

<!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹ 4åˆ— -->
<div class="grid4">
  <div class="card">
    <h2>å…¨ä½“é€²æ—</h2>
    <div class="big"><span id="m-ep">-</span><span style="font-size:.4em;color:#8b949e"> / <span id="m-ep-total">-</span> ep</span></div>
    <div style="font-size:.72em;color:#8b949e;margin:3px 0 2px">å…¨ä½“</div>
    <div class="bar-wrap"><div id="bar-ep" class="bar" style="background:#58a6ff;width:0%"></div></div>
    <div class="lrow"><span id="m-ep-pct">0%</span><span>çµŒé <span id="m-elapsed">--:--:--</span></span><span>æ®‹ã‚Š <span id="m-eta">--:--:--</span></span></div>
    <!-- ã‚¨ãƒãƒƒã‚¯å†…ãƒãƒƒãƒé€²æ— -->
    <div style="font-size:.72em;color:#8b949e;margin:6px 0 2px">
      ã‚¨ãƒãƒƒã‚¯å†… <span id="m-bat-cur">-</span> / <span id="m-bat-total">-</span> batch
      &nbsp;<span id="m-bat-pct" style="color:#58a6ff;font-weight:700">0%</span>
    </div>
    <div class="bar-wrap"><div id="bar-bat" class="bar" style="background:#388bfd;width:0%"></div></div>
  </div>

  <div class="card">
    <h2>Loss</h2>
    <div class="big" id="m-tloss" style="color:#f0883e">-.----</div>
    <div class="sub">Val Loss: <span id="m-vloss" style="color:#79c0ff">-.----</span></div>
    <div class="sub">LR: <span id="m-lr">-</span></div>
  </div>

  <div class="card">
    <h2>Accuracy</h2>
    <div class="big" id="m-acc" style="color:#3fb950">--%</div>
    <div class="sub">â˜… Best: <span id="m-best" style="color:#ffa657">--%</span></div>
    <div class="bar-wrap"><div id="bar-acc" class="bar" style="background:#3fb950;width:0%"></div></div>
  </div>

  <div class="card">
    <h2>GPU / VRAM</h2>
    <div class="lrow" style="margin-bottom:2px"><span>GPUä½¿ç”¨ç‡</span><span id="m-gpu" style="font-weight:700">0%</span></div>
    <div class="bar-wrap"><div id="bar-gpu" class="bar" style="background:#3fb950;width:0%"></div></div>
    <div class="lrow" style="margin:5px 0 2px"><span>VRAM</span><span id="m-vram" style="color:#79c0ff">0 / - GB</span></div>
    <div class="bar-wrap"><div id="bar-vram" class="bar" style="background:#2196f3;width:0%"></div></div>
  </div>
</div>

<!-- ãƒãƒ£ãƒ¼ãƒˆ -->
<div class="card" style="margin-bottom:12px">
  <h2>Loss / Accuracy ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒ¼ãƒˆ</h2>
  <div id="chart-ph" style="color:#8b949e;font-size:.82em;padding:20px;text-align:center">
    è¨“ç·´é–‹å§‹å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™
  </div>
  <div id="chart-wrap" style="display:none;position:relative;height:240px">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<!-- ä¸­é–“è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆ -->
<div class="card" style="margin-bottom:12px">
  <h2>ä¸­é–“è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆï¼ˆ100stepæ¯ï¼‰â€” æœ€æ–°20ä»¶</h2>
  <div style="overflow-x:auto">
    <table id="eval-table">
      <thead>
        <tr>
          <th>Step</th>
          <th>Ep</th>
          <th>Train Loss</th>
          <th>Val Loss</th>
          <th>Accuracy</th>
          <th>Î” Acc</th>
        </tr>
      </thead>
      <tbody id="eval-tbody">
        <tr><td colspan="6" style="text-align:center;color:#8b949e">å¾…æ©Ÿä¸­</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ã‚¨ãƒãƒƒã‚¯ãƒ­ã‚° + ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ -->
<div class="grid2">
  <div class="card">
    <h2>ã‚¨ãƒãƒƒã‚¯å±¥æ­´</h2>
    <table>
      <thead>
        <tr><th>Ep</th><th>Train Loss</th><th>Val Loss</th><th>Accuracy</th><th>æ™‚é–“</th></tr>
      </thead>
      <tbody id="ep-tbody">
        <tr><td colspan="5" style="text-align:center;color:#8b949e">å¾…æ©Ÿä¸­</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card" id="bt-card">
    <h2>ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ</h2>
    <div id="bt-wait" style="color:#8b949e;font-size:.82em;padding:8px">
      è¨“ç·´å®Œäº†å¾Œã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
    </div>
    <div id="bt-result" style="display:none">
      <div class="stat-row" id="bt-stats"></div>
      <div class="dl-section" id="dl-links"></div>
    </div>
  </div>
</div>

<div class="footer">
  æœ€çµ‚æ›´æ–°: <span id="last-upd">-</span> &nbsp;|&nbsp;
  å–å¾—å›æ•°: <span id="poll-cnt">0</span> &nbsp;|&nbsp;
  ã‚¨ãƒ©ãƒ¼: <span id="err-cnt">0</span>
</div>

<script>
// â”€â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chart       = null;
let pollTimer   = null;
let pollCount   = 0;
let errCount    = 0;
let baseUrl     = '';

// â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtSec(s) {
  if (s == null || s < 0 || s > 604800) return '--:--:--';
  s = Math.floor(s);
  const h = Math.floor(s / 3600), m = Math.floor(s % 3600 / 60), ss = s % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
function pct(a, b) { return b > 0 ? Math.min(100, Math.round(a / b * 100)) : 0; }

// â”€â”€â”€ ãƒ•ã‚§ãƒ¼ã‚ºãƒãƒƒã‚¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyPhase(phase) {
  const badge = document.getElementById('phase-badge');
  const dot   = document.getElementById('dot');
  const map = {
    loading:    ['ãƒ¢ãƒ‡ãƒ«èª­è¾¼ä¸­',    'badge-train', '#2196f3'],
    tokenizing: ['ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºä¸­',  'badge-train', '#9c27b0'],
    training:   ['è¨“ç·´ä¸­',          'badge-train', '#3fb950'],
    evaluating: ['è©•ä¾¡ä¸­',          'badge-train', '#ff9800'],
    done:       ['è¨“ç·´å®Œäº†',        'badge-done',  '#009688'],
    backtest:   ['ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆä¸­',  'badge-train', '#ff9800'],
    complete:   ['å…¨å·¥ç¨‹å®Œäº†ï¼',    'badge-done',  '#ffa657'],
    error:      ['ã‚¨ãƒ©ãƒ¼',          'badge-error', '#f44336'],
    waiting:    ['å¾…æ©Ÿä¸­',          'badge-wait',  '#8b949e'],
  };
  const [label, cls, color] = map[phase] || [phase, 'badge-wait', '#607d8b'];
  badge.textContent = label;
  badge.className   = 'badge ' + cls;
  dot.style.background = color;
}

// â”€â”€â”€ ãƒãƒ£ãƒ¼ãƒˆæ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateChart(batchLog) {
  if (!batchLog || batchLog.length === 0) return;
  document.getElementById('chart-ph').style.display   = 'none';
  document.getElementById('chart-wrap').style.display = 'block';

  // æœ€å¤§1000ç‚¹ã«é–“å¼•ã
  let data = batchLog;
  if (data.length > 1000) {
    const step = Math.ceil(data.length / 1000);
    data = data.filter((_, i) => i % step === 0);
  }

  const labels     = data.map(r => r.step);
  const trainLoss  = data.map(r => r.train_loss ?? null);
  const valLoss    = data.map(r => r.val_loss   ?? null);
  const accData    = data.map(r => r.acc        ?? null);

  const cfg = {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Train Loss', data: trainLoss,
          borderColor: '#f0883e', backgroundColor: 'transparent',
          borderWidth: 1.5, tension: .3, pointRadius: 0,
          yAxisID: 'yL', spanGaps: true },
        { label: 'Val Loss', data: valLoss,
          borderColor: '#79c0ff', backgroundColor: '#79c0ff18',
          borderWidth: 2, tension: .3, pointRadius: 3, pointHoverRadius: 6,
          yAxisID: 'yL', spanGaps: false },
        { label: 'Accuracy %', data: accData,
          borderColor: '#3fb950', backgroundColor: '#3fb95018',
          borderWidth: 2, tension: .3, pointRadius: 3, pointHoverRadius: 6,
          yAxisID: 'yA', spanGaps: false },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#e6edf3', font: { size: 11 },
          usePointStyle: true, boxWidth: 10 } },
        tooltip: {
          backgroundColor: '#161b22', borderColor: '#30363d', borderWidth: 1,
          callbacks: {
            title: items => 'Step ' + items[0].label,
            label: item => item.raw == null ? null :
              ' ' + item.dataset.label + ': ' +
              (item.datasetIndex === 2 ? item.raw + '%' : item.raw.toFixed(4))
          }
        },
      },
      scales: {
        x: { ticks: { color: '#8b949e', maxTicksLimit: 10 },
             grid: { color: '#21262d' } },
        yL: { type: 'linear', position: 'left',
              ticks: { color: '#8b949e' }, grid: { color: '#21262d' },
              title: { display: true, text: 'Loss', color: '#8b949e' } },
        yA: { type: 'linear', position: 'right', min: 0, max: 100,
              ticks: { color: '#3fb950', callback: v => v + '%' },
              grid: { drawOnChartArea: false },
              title: { display: true, text: 'Accuracy', color: '#3fb950' } },
      }
    }
  };

  if (chart) {
    chart.data = cfg.data;
    chart.update('none');
  } else {
    chart = new Chart(document.getElementById('mainChart').getContext('2d'), cfg);
  }
}

// â”€â”€â”€ ä¸­é–“è©•ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEvalTable(batchLog, totalBatches) {
  if (!batchLog || batchLog.length === 0) return;

  // accä»˜ãã‚¨ãƒ³ãƒˆãƒªã®ã¿
  const evalPts = batchLog.filter(r => r.acc != null);
  if (evalPts.length === 0) return;

  // å„è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆã«ã€Œå‰ã®è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã“ã“ã¾ã§ã®batch train_losså¹³å‡ã€ã‚’ä»˜ä¸
  // â†’ APIã®train_lossãŒå˜ãƒãƒƒãƒç¬é–“å€¤ã®å ´åˆã§ã‚‚æ­£ç¢ºãªå¹³å‡ã‚’è¨ˆç®—ã§ãã‚‹
  const evalWithAvg = evalPts.map((evalRow, ei) => {
    const prevStep = ei === 0 ? 0 : evalPts[ei - 1].step;
    const interval = batchLog.filter(r => r.step > prevStep && r.step <= evalRow.step);
    const avgTrainLoss = interval.length > 0
      ? interval.reduce((s, r) => s + (r.train_loss ?? 0), 0) / interval.length
      : (evalRow.train_loss ?? null);
    return { ...evalRow, avg_train_loss: avgTrainLoss };
  });

  const tbody = document.getElementById('eval-tbody');
  const recent = [...evalWithAvg].slice(-20).reverse(); // æœ€æ–°20ä»¶

  tbody.innerHTML = recent.map((r, i) => {
    // ã‚¨ãƒãƒƒã‚¯æ¨å®š (step ã‹ã‚‰è¨ˆç®—)
    const epNum = totalBatches > 0 ? Math.floor((r.step - 1) / totalBatches) + 1 : '-';

    // Î” Acc
    const nextRow = recent[i + 1];
    let deltaHtml = '-';
    if (nextRow && nextRow.acc != null) {
      const delta = r.acc - nextRow.acc;
      const color = delta > 0 ? '#3fb950' : delta < 0 ? '#f85149' : '#8b949e';
      deltaHtml = `<span style="color:${color}">${delta > 0 ? '+' : ''}${delta.toFixed(1)}%</span>`;
    }

    // Accuracy ã®è‰²
    const acc    = r.acc ?? 0;
    const aColor = acc >= 50 ? '#3fb950' : acc >= 40 ? '#ffa657' : acc >= 33 ? '#e6edf3' : '#f85149';

    // Train Loss (åŒºé–“å¹³å‡)
    const tl      = r.avg_train_loss;
    const tlStr   = tl != null ? tl.toFixed(4) : '-';
    const tlColor = '#f0883e';

    // Val Loss ã®è‰²ï¼ˆä½ã„ã»ã©è‰¯ã„ï¼‰
    const vl      = r.val_loss ?? 9;
    const vlColor = vl < 1.0 ? '#3fb950' : vl < 1.2 ? '#79c0ff' : vl < 1.5 ? '#ffa657' : '#f0883e';

    return `<tr style="${i === 0 ? 'background:#1c2128' : ''}">
      <td style="color:#8b949e">${r.step}</td>
      <td style="color:#58a6ff">${epNum}</td>
      <td style="color:${tlColor}">${tlStr}</td>
      <td style="color:${vlColor}">${r.val_loss?.toFixed(4) ?? '-'}</td>
      <td style="color:${aColor};font-weight:${acc>=40?'700':'400'}">${acc.toFixed(1)}%</td>
      <td>${deltaHtml}</td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€ ã‚¨ãƒãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEpochTable(log) {
  if (!log || log.length === 0) return;
  const tbody = document.getElementById('ep-tbody');
  tbody.innerHTML = [...log].reverse().map(r => {
    const acc  = r.acc != null ? (r.acc * 100).toFixed(2) + '%' : (r.acc ?? '-') + '%';
    const best = r.is_best ? ' â˜…' : '';
    return `<tr>
      <td>${r.epoch}</td>
      <td style="color:#f0883e">${r.train_loss?.toFixed(4) ?? '-'}</td>
      <td style="color:#79c0ff">${r.val_loss?.toFixed(4) ?? '-'}</td>
      <td style="color:${r.is_best ? '#ffa657' : '#3fb950'}">${acc}${best}</td>
      <td>${fmtSec(r.elapsed)}</td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBacktest(bt, apiBase) {
  if (!bt) return;
  document.getElementById('bt-wait').style.display   = 'none';
  document.getElementById('bt-result').style.display = 'block';
  const items = [
    ['PF',     bt.pf?.toFixed(3) ?? '-',                           '#ffa657'],
    ['å‹ç‡',   bt.win_rate != null ? (bt.win_rate*100).toFixed(1)+'%' : '-', '#3fb950'],
    ['å–å¼•æ•°', bt.trades ?? '-',                                     '#79c0ff'],
    ['ç´”æç›Š', bt.net_pnl?.toFixed(4) ?? '-',                       '#e6edf3'],
    ['ç²¾åº¦',   bt.accuracy != null ? (bt.accuracy*100).toFixed(2)+'%' : '-', '#3fb950'],
  ];
  document.getElementById('bt-stats').innerHTML = items.map(([l,v,c]) =>
    `<div class="stat-item">
       <div class="stat-val" style="color:${c}">${v}</div>
       <div class="stat-lbl">${l}</div>
     </div>`
  ).join('');

  // DLãƒœã‚¿ãƒ³
  const root = apiBase.replace('/api/status', '');
  document.getElementById('dl-links').innerHTML = `
    <a class="btn btn-green" href="${root}/download/report"     target="_blank">ğŸ“Š HTMLãƒ¬ãƒãƒ¼ãƒˆ</a>
    <a class="btn btn-blue"  href="${root}/download/adapter"    target="_blank">ğŸ’¾ ãƒ¢ãƒ‡ãƒ«DL</a>
    <a class="btn btn-gray"  href="${root}/download/mt5signals" target="_blank">ğŸ“¥ MT5ã‚·ã‚°ãƒŠãƒ«</a>
    <a class="btn btn-gray"  href="${root}/download/mt5ea"      target="_blank">ğŸ¤– MT5 EA</a>
  `;
}

// â”€â”€â”€ ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒªãƒ³ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStatus() {
  const url = document.getElementById('api-url').value.trim();
  if (!url) return;
  baseUrl = url;
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const d = await res.json();
    pollCount++;
    document.getElementById('poll-cnt').textContent = pollCount;
    document.getElementById('last-upd').textContent =
      new Date().toLocaleTimeString('ja-JP');

    applyPhase(d.phase ?? 'waiting');
    document.getElementById('msg').textContent = d.message ?? '';

    // ã‚¨ãƒãƒƒã‚¯
    const ep  = d.epoch ?? 0;
    const tot = d.total_epochs ?? 10;
    const bat = d.batch ?? 0;
    const totB = d.total_batches ?? 1;
    const epGlobal = (ep - 1 + bat / totB) / tot;
    const epP = Math.min(100, Math.round(epGlobal * 100));
    document.getElementById('m-ep').textContent       = ep;
    document.getElementById('m-ep-total').textContent = tot;
    document.getElementById('m-ep-pct').textContent   = epP + '%';
    document.getElementById('bar-ep').style.width     = epP + '%';
    document.getElementById('m-elapsed').textContent  = fmtSec(d.elapsed_sec);
    document.getElementById('m-eta').textContent      = fmtSec(d.eta_sec);

    // ã‚¨ãƒãƒƒã‚¯å†…ãƒãƒƒãƒé€²æ—
    const batP = Math.min(100, Math.round(bat / totB * 100));
    document.getElementById('m-bat-cur').textContent   = bat.toLocaleString();
    document.getElementById('m-bat-total').textContent = totB.toLocaleString();
    document.getElementById('m-bat-pct').textContent   = batP + '%';
    document.getElementById('bar-bat').style.width     = batP + '%';
    // æ®‹ã‚Šãƒãƒƒãƒæ•°ã«å¿œã˜ã¦è‰²å¤‰åŒ–ï¼šçµ‚ç›¤ã¯ç·‘
    const batColor = batP > 80 ? '#3fb950' : batP > 50 ? '#388bfd' : '#58a6ff';
    document.getElementById('bar-bat').style.background     = batColor;
    document.getElementById('m-bat-pct').style.color        = batColor;

    // Loss / LR
    document.getElementById('m-tloss').textContent = d.train_loss?.toFixed(4) ?? '-.----';
    document.getElementById('m-vloss').textContent = d.val_loss?.toFixed(4)   ?? '-.----';
    document.getElementById('m-lr').textContent    =
      d.lr != null ? d.lr.toExponential(2) : '-';

    // Accuracy
    const accV  = (d.accuracy  ?? 0) * 100;
    const bestV = (d.best_acc  ?? 0) * 100;
    document.getElementById('m-acc').textContent  = accV.toFixed(2)  + '%';
    document.getElementById('m-best').textContent = bestV.toFixed(2) + '%';
    document.getElementById('bar-acc').style.width = Math.min(100, accV) + '%';
    // è‰²ï¼š50%è¶…ã§ç·‘ã€35%æœªæº€ã§æ©™
    const accColor = accV >= 50 ? '#3fb950' : accV >= 35 ? '#ffa657' : '#f0883e';
    document.getElementById('m-acc').style.color  = accColor;
    document.getElementById('bar-acc').style.background = accColor;

    // GPU / VRAM
    const gpuP  = d.gpu_pct  ?? 0;
    const vramU = d.vram_used_gb  ?? 0;
    const vramT = d.vram_total_gb ?? 0;
    const vramP = pct(vramU, vramT);
    const gpuColor = gpuP > 90 ? '#f44336' : gpuP > 75 ? '#ff9800' : '#3fb950';
    document.getElementById('m-gpu').textContent       = gpuP + '%';
    document.getElementById('m-gpu').style.color       = gpuColor;
    document.getElementById('bar-gpu').style.width     = gpuP + '%';
    document.getElementById('bar-gpu').style.background = gpuColor;
    document.getElementById('m-vram').textContent      =
      `${vramU.toFixed(1)} / ${vramT.toFixed(0)} GB`;
    document.getElementById('bar-vram').style.width    = vramP + '%';

    // ãƒãƒ£ãƒ¼ãƒˆãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«
    if (d.batch_log)  updateChart(d.batch_log);
    if (d.batch_log)  updateEvalTable(d.batch_log, d.total_batches ?? 1628);
    if (d.epoch_log)  updateEpochTable(d.epoch_log);
    if (d.backtest_result) updateBacktest(d.backtest_result, url);

  } catch (e) {
    errCount++;
    document.getElementById('err-cnt').textContent = errCount;
    document.getElementById('msg').textContent = 'âš  å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message;
  }
}

function startPolling() {
  stopPolling();
  fetchStatus();
  const ms = parseInt(document.getElementById('interval-sel').value, 10);
  pollTimer = setInterval(fetchStatus, ms);
}
function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

// æ›´æ–°é–“éš”å¤‰æ›´æ™‚ã«å†ã‚¹ã‚¿ãƒ¼ãƒˆ
document.getElementById('interval-sel').addEventListener('change', () => {
  if (pollTimer) startPolling();
});

// èµ·å‹•æ™‚ã«è‡ªå‹•ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
startPolling();
</script>
</body>
</html>
