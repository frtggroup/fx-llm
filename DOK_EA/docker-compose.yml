version: "3.9"

services:
  fx-ea:
    build:
      context: ..
      dockerfile: DOK_EA/Dockerfile
    image: fx-ea:latest
    container_name: fx-ea-h100

    # H100 GPU を全台使用
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    ports:
      - "7860:7860"   # ダッシュボード
      - "2222:22"     # SSH

    environment:
      # H100 80GB モード (大型モデル・大バッチ)
      H100_MODE: "1"
      # データ CSV の URL (起動時に自動ダウンロード)
      # DATA_URL: "https://your-storage/USDJPY_M1.csv"
      DATA_PATH: "/workspace/data/USDJPY_M1.csv"

    volumes:
      # CSV データ永続化 (ホストから提供する場合)
      - ./data:/workspace/data
      # 学習結果・モデル永続化
      - ./output:/workspace/ai_ea/output_ext

    restart: unless-stopped

    # コンテナのリソース制限 (必要に応じて調整)
    shm_size: "4gb"

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
