version: "3.9"

services:
  fx-ea:
    build:
      context: ..
      dockerfile: DOK_EA/Dockerfile
    image: frtggroup/fx-ea-v2:latest
    container_name: fx-ea-h100

    # H100 GPU を全台使用
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    ports:
      - "7860:7860"   # ダッシュボード
      - "2222:22"     # SSH

    environment:
      # H100 80GB モード (大型モデル・大バッチ)
      H100_MODE: "1"
      # 並列学習数 (VRAM 空き監視で動的調整)
      MAX_PARALLEL: "6"
      # 1試行あたりの最低 VRAM (GB) - H100 80GB / 6並列 ≈ 13GB/試行
      VRAM_PER_TRIAL: "13"
      # バックテスト設定 (MQL5 LotSize相当)
      BT_CAPITAL: "150000"
      BT_LEVERAGE: "1000"
      BT_RISK_PCT: "1.0"       # 残高の1%をリスクにロット決定 (変更可: 0.5〜2.0)
      # ノードID (GDrive 上でファイルを分離するために必須)
      NODE_ID: "h100"
      # Google Drive 共有ストレージ (全ノードが同じフォルダを競合なしで共有)
      GDRIVE_FOLDER_ID: "1RhIqnpyzQrSuEgIAD7KroNWfELdElS6L"
      GDRIVE_CREDENTIALS_BASE64: "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAidGVzdC00ODI3MTAiLAogICJwcml2YXRlX2tleV9pZCI6ICIwOWM4YzExZGVmMTE3N2QzY2I5YTYzZGYyNzQ3YmVmMGVmNDQ3NDI1IiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUM2ZkdHNk9HZFJySGpRXG45ZXZVd2p0SThMUEtDMzdLdGJpc3JRZVhBcmJrd1R2WDEvSWdlSkJVdVdRbGdiaGhUTDloZXRoLys2VmdBaFdBXG5zR2JacDVLOUsxOHh1WEk2LzllNEFPeWhSc2RBY3JsZERFUFZIdWo4ZS9pdE5LcGI5R0ZON2VESjluWEU2TnhmXG5xejR4WVNqdk9KdkRoMDV5VmIvalZvY05FNEdKMC9obG96YUt5NGVGZ0pCSzdvOXh1dDMxdzRhTFZtOGZRcSs0XG52WElkN29CRmVNTnl5dGpYWklVRHZ0STRLM3gyM0F0QVcwdVNiWHMrMy9Fa1RlYXdSNW41VkJXZk1Sa25EMVpDXG5QV2xVcW1zcXhBbHVka3NjVHFhQWNlYW5VUGdEb0s1ME9OSGNBS2cxblUyWkU3N3lWTnBFRkk0T0tNZVZjeFczXG5LR3hCVXZuL0FnTUJBQUVDZ2dFQUhLQ1FiZ0pQbGdHWWNGZDRFdXFZS0R2UEZiS0xEYm8wdGNsQUU0WDJwb29sXG5VaDZUekRsRnlzUEU1RjhUKzFmSlAwRVk4QmlreSthMS8xSFZFQStCM3FsRVRVRlBFRkNMQUhPZjM2Z2FXVUhqXG5RNjNvMGRRVFp3THU2MFBjN1EzSVRDcTZxYlk4WVBSd00vMTVLQ0ptb3NaNVh0d3NCakEwcTBUeXFXYTNxWDBPXG5HNXZ1Zk5Ub0QxQ0tJRGs1NWFTNjNjZzc3ZlA5QTVmWnhTdmR1ODdJODV4L3d5UUYrUnJCZ3dQRC8wV2hSNnlnXG5GeVdLYnBGbUMxVmhlaEgvaXlGUmhNVVdkTkphQWRDclVxdWNmOThvWDFnYklmZEExTFczNDdBZUNONkpIU3J5XG51UlA4bDdta1YxVGhrR2NXajFtUEFGV0lpWEt5eXRodzdsZE5Wb2JIVlFLQmdRRGRNa1A3ZCt1STZxcW53OGVEXG5ZdXJqWUE1Uy9ubFYyOGZCUXlLTzZWOGdWdUdGS0tacktDRjU4SFhmVk5VMncyNG9zTGNCU0dQeHFRQUx0c3VzXG5keGRRako4SGI5b2NBeityblBmam1jVDVJcmdENVB5NEhTam9XMDN3eU9RRVZkNC92ZFNiNEUyekM0YUh6ZDA3XG5ETWpjUXQxR2wveFlxR0wxY2NmQUk4SlF0UUtCZ1FEWDAveUpLVFRpcFk3OTN0Zm9KT0kxNy9taUZVZ3pzekVhXG5iZnIvNnJDUUFKSFcyUTJDNm9VWkp5QTFtQW4xVHgrUmEyQzNXU1RRRUtxYXNhZGpkSmlQbWtRRXJ1RmJLS2Q0XG5sYVk5RG51SVlyLzlTbWptUlJKcCtOQXk5eFMrV2ZPTHp6SXQrWnRFQmJ2T1AxVUdweHlvSThpVVVtYzFJdzIyXG40UVp5NUVVMFl3S0JnUURKK1pYOXpyaHhZdVhGSG8zVk9NT0dMeldsTHR3WVBBRWdSVzhPMDZXYTMvbzVIcThtXG45WlByeGxlN1A3a1lza2FxUFFJOTE1MzdFZmdLdWpVc0crcGNFS3M5blRLcGxZWFQ3QmFsNnNqalBJS09lODhQXG5Sd0VOZWlHbkZhaXZGTUZGcnM2dUxwaUVQcWZ1NVZsM0MrdDB4RkZNbm9jN1pUWkhMRWZhK0V2OGFRS0JnRkpnXG5jUVVSRzBSZW1JTkJhUHNNQ09NNVl2aUFVdnlZcW1kQ0R3bGExR1ZDTW1ma2xJbWhaWWZDTFVNSGN0V1VpNkgvXG5iL3pMSTRmZXRKOHlxNGNFVzY2RDNPNUVxWE1YdzBQOUttUW5nUEwvYmZRSlVKeURSSkg2QzgxSURUelNMR2p5XG5mbDZaNUs5RDJQalJwMnhRb0ZsMHZ2d05yNkxTYkV1ZSs4MGlYMSt0QW9HQkFJaVlSMURaTnBYYXFtaEJnQmcyXG54NGQ1cE1HbncyRTJIVy9tQlJCY2dqNG5JNVlld3llZDBqUWhMOHNOTWIwRjZxYmR2cERMK3k3NVFxd3Bvell6XG5ReTcrMG5teDBOdWlGRkVtNjFTYkZGRmg1aXpJV2k4NzArV1FQWXc2RjhmendxczlOV2d6UDRGZlFiNlE2UEhkXG52cjl2Z3ZtVjMweXRYZnlCL2FoNnhhYXZcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJmeGVhLTg2MkB0ZXN0LTQ4MjcxMC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMTc4Njg5OTg2NTYyMzM0MzE2MzQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2Z4ZWEtODYyJTQwdGVzdC00ODI3MTAuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K"
      # OAuth2 シークレット: Sakura DOK の環境変数パネルで設定
      # GDRIVE_OAUTH_CLIENT_ID: "..."
      # GDRIVE_OAUTH_CLIENT_SECRET: "..."
      # GDRIVE_OAUTH_REFRESH_TOKEN: "..."
      # Sakura S3 (フォールバック / GDrive が有効な場合は使用されない)
      # S3_ENDPOINT: "https://s3.isk01.sakurastorage.jp"
      # S3_BUCKET: "fxea"
      # データ CSV の URL (起動時に自動ダウンロード / 既存なら skip)
      DATA_URL: "https://fxea.s3.isk01.sakurastorage.jp/USDJPY_M1.csv"
      # Sakura DOK では /opt/artifact が永続ストレージ
      DATA_PATH: "/opt/artifact/data/USDJPY_M1.csv"

    # Sakura DOK では /opt/artifact が永続ストレージとして自動マウントされる
    # ローカル volume mount は DOK CaaS 環境では不要

    restart: unless-stopped

    # 共有メモリ (大バッチ学習時に必要)
    shm_size: "8gb"

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
